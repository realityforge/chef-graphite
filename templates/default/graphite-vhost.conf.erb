# Graphite Apache Virtual Host
#
# Generated by Chef

# You may need to manually edit this file to fit your needs.

WSGIPythonOptimize 1

<VirtualHost <%= node['graphite']['web']['interface'] %>:<%= node['graphite']['web']['port'] %>>
    ServerName <%= node['graphite']['web']['host'] %>
    DocumentRoot "<%= node['graphite']['base_dir'] %>/webapp"
    ErrorLog <%= node['graphite']['storage_dir'] %>/log/webapp/error.log
    CustomLog <%= node['graphite']['storage_dir'] %>/log/webapp/access.log common

    WSGIDaemonProcess graphite \
        user=<%= node['apache']['user'] %> processes=10 threads=5 maximum-requests=100000 inactivity-timeout=300 \
        python-path=<%= node['graphite']['base_dir'] %>/webapp

    WSGIProcessGroup graphite

    WSGIScriptAlias / <%= node['graphite']['base_dir'] %>/conf/graphite.wsgi
    WSGIImportScript <%= node['graphite']['base_dir'] %>/conf/graphite.wsgi process-group=graphite application-group=%{GLOBAL}

    SetEnv DJANGO_SETTINGS_MODULE graphite.settings
    SetEnv GRAPHITE_STORAGE_DIR <%= node['graphite']['storage_dir'] %>/

    <Location "/content/">
            SetHandler None
    </Location>

    <Location "/media/">
            SetHandler None
    </Location>

  <% if node['recipes'].include? "ganglia::web" -%>
	<Location "/ganglia/">
	        SetHandler None
	</Location>
  <% end -%>

  <% if node['gdash'] && node['gdash']['prefix'] -%>
    <Location "<%= node['gdash']['prefix'] %>">
      Order allow,deny
      Allow from all
      SetHandler None
    </Location>

    ProxyPass              <%= node['gdash']['prefix'] %>  http://<%= node['gdash']['interface'] %>:<%= node['gdash']['port'] %>
    ProxyPassReverse       <%= node['gdash']['prefix'] %>  http://<%= node['gdash']['interface'] %>:<%= node['gdash']['port'] %>
  <% end -%>



</VirtualHost>
